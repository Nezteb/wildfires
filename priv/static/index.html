<!DOCTYPE html>
<html>

<head>
  <title>GeoJSON WebSocket Example</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    #map {
      height: 100vmin;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script>
    const socket = new WebSocket('ws://' + window.location.host + '/ws');
    
    socket.onopen = function () {
      socket.send("refresh");
    };

    // Lat and long of LA
    const map = L.map('map').setView([34.052235, -118.243683], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let geoJsonLayer = null;

    socket.onmessage = function (event) {
      console.log("Received event", event);

      let geojsonData = null;
      try {
       geojsonData = JSON.parse(event.data);
      } catch (e) {
        console.error("Invalid JSON data", event.data);
        return;
      }

      if (geoJsonLayer) {
        console.log("Removing existing GeoJSON layer", geoJsonLayer);
        map.removeLayer(geoJsonLayer);
      }

      geoJsonLayer = L.geoJSON(geojsonData, {
        style: function (feature) {
          return {
            color: feature.properties.color || "#ff0000",
            weight: 2,
            opacity: 1
          };
        }
      }).addTo(map);
    };

    // Example function to send GeoJSON updates to server
    function updateGeoJSON(geojsonData) {
      socket.send(JSON.stringify({
        event: "update_geojson",
        data: geojsonData
      }));
    }

    window.mapSocket = socket
  </script>
</body>

</html>
